<script>
  const API_BASE = 'https://id1rasld2a.execute-api.us-east-1.amazonaws.com/prod';
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const status = document.getElementById('status');
  const result = document.getElementById('result');
  const emailInput = document.getElementById('email');
  const notifyInput = document.getElementById('notify');

  function setStatus(s){ status.innerText = s; }

  function showResults(data){
    let html = `<h4>Receipt ID: ${data.receiptId}</h4>`;
    if(data.summary){
      html += `<h5>Summary</h5><ul>`;
      for(const [k,v] of Object.entries(data.summary)){
        html += `<li><strong>${k}:</strong> ${v}</li>`;
      }
      html += `</ul>`;
    }
    if(data.lineItems){
      html += `<h5>Line Items</h5><ul>`;
      for(const item of data.lineItems){
        html += `<li>${item.ItemIdentification} — ${item.Price}</li>`;
      }
      html += `</ul>`;
    }
    result.innerHTML = html;
  }

  uploadBtn.addEventListener('click', async () => {
    const f = fileInput.files[0];
    if(!f){ alert('Choose a file'); return; }
    setStatus('Reading file...');
    const reader = new FileReader();
    reader.onload = async function(ev){
      const b64 = ev.target.result.split(',')[1];
      setStatus('Uploading to API...');
      const payload = {
        filename: f.name,
        file_base64: b64,
        email: emailInput.value || null,
        notify: notifyInput.checked
      };
      try {
        const res = await fetch(API_BASE + '/upload', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        setStatus('Done');
        if(notifyInput.checked){
          result.innerHTML = `<p>✅ Processed and emailed to ${emailInput.value}</p>
                              <p>Receipt ID: ${data.receiptId}</p>`;
        } else {
          showResults(data);
        }
      } catch (err){
        setStatus('Error: ' + err.message);
      }
    };
    reader.readAsDataURL(f);
  });
</script>
